# Сервис Аутентификации и Авторизации на FastAPI

```
src/
├── api/              # Слой API (роутеры, эндпоинты, зависимости FastAPI)
├── core/             # Ядро приложения (конфигурация, логгер)
├── db/               # Все, что связано с базой данных (модели, хелперы)
├── domain/           # Доменная логика (сущности, исключения)
├── dto/              # Data Transfer Objects
├── repository/       # Слой репозиториев (абстракции для доступа к данным)
├── schemas/          # Схемы Pydantic для валидации данных API
└── services/         # Слой сервисов (бизнес-логика)
```

## Настройка почты для разработки (`.env`) (метод авторизации пользователя (JWT) может работать без этого, можно пропустить)

Для корректной работы верификации по email в тестовом и локальном окружении, необходимо настроить отправку почты. Рекомендуется использовать специальный пароль для приложений Google (App Password), что безопаснее, чем использование основного пароля от аккаунта.

### Шаг 1: Создание пароля для приложений в Google

**Важно:** Для создания пароля приложений у вас должна быть включена **двухэтапная аутентификация** в аккаунте Google.

1.  **Перейдите в настройки аккаунта Google:**
    Откройте страницу [https://myaccount.google.com/](https://myaccount.google.com/).

2.  **Включите двухэтапную аутентификацию:**
    -   В меню слева выберите "Безопасность".
    -   В разделе "Вход в аккаунт Google" найдите пункт "Двухэтапная аутентификация" и следуйте инструкциям для ее включения.

3.  **Создайте пароль для приложения:**
    -   Вернитесь в раздел "Безопасность".
    -   Найдите блок "Пароли приложений" (он появится только после включения двухэтапной аутентификации). [https://myaccount.google.com/apppasswords?roistat_visit=4096631]

4.  **Сохраните пароль:**
    Google сгенерирует 16-значный пароль. **Скопируйте и сохраните его в надежном месте.** Этот пароль будет использоваться в `.env` и не будет показан снова.

### Шаг 2: Заполнение файла `.env`

Создайте файл `.env` в корневой директории проекта и заполните его следующими переменными, используя данные вашего аккаунта и сгенерированный пароль:

```env
# .test.env

# --- Mail Settings ---
# Ваш email-адрес, который будет использоваться для отправки писем
MAIL_USERNAME="your.email"

# 16-значный пароль для приложений, сгенерированный на Шаге 1
MAIL_PASSWORD="your-16-character-app-password"

# Тот же email, что и MAIL_USERNAME, но с доменном почты
MAIL_FROM="your.email@gmail.com"

# Имя отправителя, которое будет отображаться в письме
MAIL_FROM_NAME="My FastAPI Project"

# SMTP сервер Google
MAIL_SERVER="smtp.gmail.com"
MAIL_PORT=587
MAIL_STARTTLS=true
MAIL_SSL_TLS=false
USE_CREDENTIALS=true
VALIDATE_CERTS=true
```

После выполнения этих шагов ваш проект будет готов к отправке писем для верификации пользователей.

## Технологический стек

- **Фреймворк**: FastAPI
- **База данных**: PostgreSQL (через `asyncpg`), Redis
- **ORM**: SQLAlchemy 2.0
- **Миграции**: Alembic
- **Аутентификация**: PyJWT, passlib[bcrypt]
- **Валидация данных**: Pydantic
- **Управление зависимостями**: uv
- **Тестирование**: Pytest, Hypothesis, Schemathesis
- **Линтинг/Форматирование**: Ruff
- **Контейнеризация**: Docker

## Установка и запуск

### Запуск с помощью Docker

1.  **Склонируйте репозиторий:**
    ```bash
    git clone https://github.com/nikuIin/install_biz_fastapi_auth
    cd install_biz_fastapi_auth
    ```

2.  **Настройте переменные окружения:**
    Убедитесь, что у вас есть файл `.env` с корректными настройками для баз данных и других сервисов. Пример окружения представлен в `.env.example` файле. (Для работы сервера подтверждения регистрации важно настроить `SMTP` сервер, инструкция описывается выше в этом файле.)

3.  **Соберите и запустите контейнеры:**

    ```bash
    docker-compose up --build
    ```

    Или:
    ```bash
    docker compose up --build
    ```

Сервис будет запущен по адресу `http://localhost/`,  `swagger` будет по пути: `http://localhost/api/openapi`

### Локальный запуск (без Docker)

1.  **Склонируйте репозиторий:**
    ```bash
    git clone https://github.com/nikuIin/install_biz_fastapi_auth
    cd install_biz_fastapi_auth
    ```

2.  **Установите `uv`:**
    ```bash
    pip install uv
    ```

3.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    uv venv
    source .venv/bin/activate
    ```

4.  **Установите зависимости:**
    ```bash
    uv sync
    ```

5.  **Настройте переменные окружения:**
    Создайте файл `.env` в корне проекта (можно скопировать из `.env.example`, если он есть) и укажите необходимые значения (данные для подключения к БД, секретные ключи и т.д.).


6.  **Создайте базу данных **
    ```sql
    create database base_fastapi_auth with
    encoding="UTF-8"
    lc_collate="ru_RU.utf8"
    lc_ctype="ru_RU.utf8"
    owner your_cute_db_name;
    ```

7.  **Примените миграции Alembic:**
    ```bash
    alembic upgrade head
    ```

8.  **Запустите приложение:**
    ```bash
    make start
    ```
    Сервис будет доступен по адресу `http://127.0.0.1:8000`.
